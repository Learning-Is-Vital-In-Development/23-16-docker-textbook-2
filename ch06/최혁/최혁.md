---
marp: true
---

# 도커 볼륨을 이용한 퍼시스턴스 스토리지

## 최 혁

---

# 기록 가능 레이어

- 컨테이너의 파일 시스템은 단일 디스크다. 이 디스크는 도커가 이미지 레이어와 기록 가능 레이어를 합쳐 만들고 컨테이너에 전달한 가상 파일 시스템이다.
- 기록 가능 레이어는 컨테이너와 같은 생애주기를 갖는다.
- 기록 가능 레이어는 컨테이너마다 다르다.
- 기록 기능 레이어는 copy-on-write 방법으로 읽기 전용 레이어의 파일을 수정할 수 있다.

### 컨테이너에서 이미지 레이어에 포함된 파일 수정하면?

`도커가 파일을 쓰기 가능 레이어로 복사 -> 쓰기 가능 레이어에서 파일 수정`

---

# 도커 볼륨을 사용하는 컨테이너 실행하기

- 도커 볼륨: 도커에서 스토리지를 다루는 단위(컨테이너를 위한 USB)
- 볼륨은 컨테이너와 독립적으로 존재하며 별도의 생명주기를 갖는다.
- 볼륨을 컨테이너에 연결하면 컨테이너 파일 시스템의 한 디렉터리가 된다.

### 컨테이너에서 볼륨을 사용하는 방법

1. 수동으로 직접 볼륨을 생성해 컨테이너에 연결
   `docker volume create [name]`
2. Dockerfile 스크립트에서 VOLUME instruction 문법 사용
   `VOLUME <target-directory>`

---

### 두 컨테이너가 한 볼륨을 공유하는 방법

```shell
# 이 컨테이너 실행 시 볼륨 생성
docker container run --name todo2 -d diamol/ch06-todo-list
docker container exec todo2 ls /data

# 이 컨테이너는 todo1의 볼륨을 공유한다.
docker container run -d --name t3 --volumes-from todo1 diamol/ch06-todo-list
docker container exec t3 ls /data
```

- 볼륨은 컨테이너 간 파일 공유보다는 업데이트 간 상태를 보존하기 위한 용도로 사용해야 한다.
- 따라서 이미지에서 정의하는 것보다는 명시적으로 관리하는 편이 더 낫다.
- 볼륨에 이름을 붙여 생성하고 업데이트 시 다른 컨테이너로 옮겨 연결하면 된다.

---

# 수동으로 볼륨 생성하여 연결

```shell
# 복사 대상 경로를 환경 변수로 정의한다.
target='/data'

# 데이터를 저장할 볼륨 생성
docker volume create todo-list

# 볼륨을 연결해 v1 애플리케이션을 실행
docker container run -d -p 8011:80 -v todo-list:$target --name todo-v1
diamol/ch06-todo-list

# v1 애플리케이션 삭제
docker container rm -f todo-v1

docker container run -d -p 8011:80 -v todo-list:$target --name todo-v2
diamol/ch06-todo-list:v2
```

---

# 볼륨 정리

- Dockerfile 스크립트의 VOLUME과 docker container 명령의 --volume 블래그는 별개 기능
- VOLUME instruction을 사용해 빌드된 이미지로 컨테이너를 만들 때 볼륨을 지정하지 않으면 항상 새로운 볼륨이 함께 생성됨
- 이미지를 만드는 입장에서 VOLUME 인스트럭션을 이미지 정의에 포함시켜 두는 것이 좋다.
- 사용자 입장에서는 별도의 이름을 붙여 만든 볼륨을 사용하는 것이 좋다.

---

# 파일 시스템 마운트를 사용하는 컨테이너 실행하기
